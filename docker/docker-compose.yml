version: '3'

networks:
  app-tier:
    driver: bridge

services:
  mongodb-primary:
    container_name: mongodb-primary
    image: bitnami/mongodb
    environment:
      - MONGODB_ADVERTISED_HOSTNAME=mongodb-primary
      - MONGODB_REPLICA_SET_MODE=primary
      - MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      - MONGODB_REPLICA_SET_KEY=replicasetkey123
    volumes:
      - ./mongodb:/bitnami/mongodb
    networks:
      - app-tier

  mongodb-secondary:
    container_name: mongodb-secondary
    image: bitnami/mongodb
    depends_on:
      - mongodb-primary
    environment:
      - MONGODB_ADVERTISED_HOSTNAME=mongodb-secondary
      - MONGODB_REPLICA_SET_MODE=secondary
      - MONGODB_INITIAL_PRIMARY_HOST=mongodb-primary
      - MONGODB_INITIAL_PRIMARY_PORT_NUMBER=27017
      - MONGODB_INITIAL_PRIMARY_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      - MONGODB_REPLICA_SET_KEY=replicasetkey123

  mongodb-arbiter:
    container_name: mongodb-arbiter
    image: bitnami/mongodb
    depends_on:
      - mongodb-primary
    environment:
      - MONGODB_ADVERTISED_HOSTNAME=mongodb-arbiter
      - MONGODB_REPLICA_SET_MODE=arbiter
      - MONGODB_INITIAL_PRIMARY_HOST=mongodb-primary
      - MONGODB_INITIAL_PRIMARY_PORT_NUMBER=27017
      - MONGODB_INITIAL_PRIMARY_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      - MONGODB_REPLICA_SET_KEY=replicasetkey123

  nuxt:
    container_name: nuxt
    build: ..
    env_file: .env
    depends_on:
      - mongodb-primary
    ports:
      - "3000:3000"
    networks:
      - app-tier
    environment:
      - DATABASE_URL=mongodb://root:${MONGODB_ROOT_PASSWORD}@mongodb-primary/esp-admin?authSource=admin&retryWrites=true&w=majority

  emqx:
    container_name: emqx
    image: emqx/emqx
    env_file: .env
    ports:
      - "18083:18083"
      - "1883:1883"
      - "8083:8083"
    environment:
      - EMQX_NODE__COOKIE=emqx
    volumes:  
      - "./emqx/data:/opt/emqx/data"
      - "./emqx/etc:/opt/emqx/etc"
      - "./emqx/log:/opt/emqx/log"
 